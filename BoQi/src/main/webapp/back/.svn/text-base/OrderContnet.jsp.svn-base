<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<table id="ordercontent_info" data-options="fit:true"></table>
<script>
$(function(){
	var datagrid;
	var editRow=undefined;
	var op;
	var flag;
	var tty;
	//未确认	取消	确认	已付款	配货中	已发货	已收货	退货
	var statusObj=[{sid:0,sname:'失效'},{sid:1,sname:'未处理'},{sid:2,sname:'确定'}];

	
	datagrid=$('#ordercontent_info').datagrid({
		url:'orderContentServlet',
		queryParams:{op:"getPageOrderInfo"},
		fitColumns:true,
		striped:true,
		loadMsg:"数据加载中...",
		pagination:true,
		rownumbers:true,
		sortName:'orderid',
		remoteSort:false,
		idField: 'orderid',
		columns:[[
		    {field:'orderids',title:'订单编号',width:100,align:'center',checkbox:true},
		    {field:'orderid',title:'订单编号',width:100,align:'center'},
		    {field:'uname',title:'客户姓名',width:100,align:'center',editor:{type:"text",options:{required:true}}},
		    {field:'starttime10',title:'订单日期',width:100,align:'center',editor:{type:"text",options:{required:true}}},
		    {field:'ordersum',title:'订单金额',width:100,align:'center',editor:{type:"text",options:{required:true}}},
		    {field:'orderstate',title:'订单状态',width:100,align:'center',editor:{type:"combobox",options:{
				required:true,valueField:'sid',textField:'sname',data:statusObj}},
				formatter:function(value,row,index){
				  for(var i=0;i<statusObj.length;i++){
				  	if(statusObj[i].sid==value){
				  		return statusObj[i].sname;
				  		}
				  	}
				  	return value;
				  }
			},
		    {field:'_operate',title:'操作',width:100,align:'center',
		    	formatter:function(value,rowData,index){
		    		return '<a class="icon-search1 icon-padding" href="javascript:showNewsDetail(\''+rowData.orderid+'\')">详细</a>';
		    	}
		    }
		]],toolbar:[{
			text:"修改",
			iconCls:'icon-edit',
			handler:function(){
				var rows = datagrid.datagrid("getChecked")[0];
				if(rows == undefined){
					$.messager.show({title:'温馨提示',msg:'请选择您要修改的数据...',timeout:2000,showType:'slide'});
				}else{
					$("#ordercontent_show_ordercontentInfo2").dialog("open");
					showNewsDetail2(rows.orderid);
				}
			}
		},{
			text:"删除",
			iconCls:'icon-remove',
			handler:function(){
				//获取所有被选中的行
				var rows = datagrid.datagrid("getChecked")[0];
				if(rows.length<=0){//没有选择任何一行
					$.messager.show({
						title:'温馨提示',
						msg:'请选择您要删除的数据...',
						timeout:2000,
						showType:'slide'
					});
				}else{
					$.messager.confirm('信息确认','您确定要删除选中的数据吗？',function(r){
						if(r){
							var orderids = "";
							for(var i = 0;i<rows;i++){
								orderids += rows[i].orderid+",";
							}
							orderids += rows[i].orderid;
							
							//讲要删除aid发送到服务器
							$.post("typeServlet",{op:"delNewstypeInfo",orderids:orderids},function(data){
								if(data == 1){//添加成功
									$.messager.show({
										title:'删除提示',
										msg:'新闻类型信息删除成功...',
										timeout:2000,
										showType:'slide'
									});
									datagrid.datagrid("reload");//重新加载数据一次
								}else{
									$.messager.alert('失败提示','新闻类型信息删除失败...','error');
								}
							});
						}
					});
				}
			}
		},{
			text:"保存",
			iconCls:'icon-save',
			handler:function(){
				datagrid.datagrid("endEdit",editRow);//关闭当前正在编辑的行
				
				//获取当前被修改的数据
				var rows = datagrid.datagrid("getChanges")[0];
				if(rows==undefined){
					datagrid.datagrid("rejectChange");//滚回自创建以来或自上次调用AcceptChange,所有的变化数据
					datagrid.datagrid("unselectAll");
					editRow=undefined;
				}else{
					rows["op"]=op;
					$.post("orderContentServlet",rows,function(data){
						data = parseInt($.trim(data));
						if(data==1){//添加成功
							$.messager.show({
								title:'成功提示',
								msg:'新闻类型信息'+flag+'成功...',
								timeout:2000,
								showType:'slide'
							});
						}else{
							$.messager.alert('失败提示','新闻类型信息'+flag+'失败...','error');
						}
						rows = null;
						datagrid.datagrid("reload");//重新加载数据一次
						editRow = undefined;
						datagrid.datagrid("rejectChanges");//滚回自创建以来或自上次调用AcceptChange,所有的变化数据
						datagrid.datagrid("unselectAll");
					});
				}
			}
		}]
	});
});
</script>
<!-- 商品详情浏览 -->
<div id="ordercontent_show_ordercontentInfo" class="easyui-dialog" title="订单详细" data-options="fit:true,iconCls:'icon-search1',resizable:true,modal:true,closed:true">
	<center>
	<div id="content_show" id="content_show">
		<div class="content_buyer wwidth">
			<label class="tt" style="margin-left:20px;">买家昵称：</label><span class="tt" id="content_buyer_name"></span>
			<label class="tt" style="margin-left:60px;">买家电话：</label><span class="tt" id="content_buyer_tel"></span></br/><br/>
			<label class="tt" style="margin-left:20px;">买家地址：</label><span class="tt" id="content_buyer_addr"></span></br/><br/>
		</div>
		<div id="content_up" class="wwidth">
			<label class="tt" style="margin-left:20px;">订单编号：</label><span class="tt" id="content_id"></span></br/><br/>
			<label class="tt" style="margin-left:20px;">成交时间：</label><span class="tt" id="content_maketime"></span>
			<label class="tt" style="margin-left:60px;">付款时间：</label><span class="tt" id="content_paytime"></span>
			<label class="tt" style="margin-left:60px;">确认时间：</label><span class="tt" id="content_suretime"></span>
		</div>
		<table id="content_table">
			<thead>
				<tr class="content_top_title">
					<th class="content_goods">商品</th>
					<th class="content_attr">商品属性</th>
					<th class="content_pri">单价</th>
					<th class="content_num">数量</th>
					<th class="content_status">状态</th>
				</tr>
			</thead>
			<tbody id="content_tbody">
				
			</tbody>
			<tfoot>	
				<tr class="content_total">
					<td id="all_td" colspan="5">
						<div id="haha">
							<label>订单总金额：</label><strong id="total_money"></strong>&nbsp元
						</div>
					</td>
				</tr>
			</tfoot>
		</table>
	</div>
	</center>
</div>

<!-- 商品修改页面 -->
<div id="ordercontent_show_ordercontentInfo2" class="easyui-dialog" title="修改信息" data-options="fit:true,iconCls:'icon-add',resizable:true,modal:true,closed:true">
	<center>
	<div id="content_show">
		<div class="content_buyer wwidth">
			<label class="tt" style="margin-left:20px;">买家昵称：</label><input class="tt" id="content_buyer_name2"></input>
			<label class="tt" style="margin-left:60px;">买家电话：</label><input class="tt" id="content_buyer_tel2"></input></br/><br/>
			<label class="tt" style="margin-left:20px;">买家地址：</label><input style="width:400px;" class="tt" id="content_buyer_addr2"></input></br/><br/>
		</div>
		<div id="content_up" class="wwidth">
			<label class="tt" style="margin-left:20px;">订单编号：</label><span class="tt" id="content_id2"></span></br/><br/>
			<label class="tt" style="margin-left:20px;">成交时间：</label><span class="tt" id="content_maketime2"></span>
			<label class="tt" style="margin-left:60px;">付款时间：</label><span class="tt" id="content_paytime2"></span>
			<label class="tt" style="margin-left:60px;">确认时间：</label><span class="tt" id="content_suretime2"></span>
		</div>
		<table id="content_table">
			<thead>
				<tr class="content_top_title">
					<th class="content_goods">商品</th>
					<th class="content_attr">商品属性</th>
					<th class="content_pri">单价</th>
					<th class="content_num">数量</th>
					<th class="content_status2">状态</th>
				</tr>
			</thead>
			<tbody id="content_tbody2">
				
			</tbody>
			<tfoot>	
				<tr class="content_total">
					<td id="all_td" colspan="5">
						<div id="haha">
							<label>订单总金额：</label><span id="total_money2"></span>&nbsp元
						</div>
					</td>
				</tr>
			</tfoot>
		</table>
		<div class="allsure">
			<input type="button" onclick="sendInfo()" class="yoyo" value="提交"/>
		</div>
	</div>
	</center>
</div>
<script>	

//弹开修改页面
function showNewsDetail2(orderid){
	$("#ordercontent_show_ordercontentInfo2").dialog("open");
	$.post("orderContentServlet",{op:"findOrderContentByorderid",orderid:orderid},function(data){
		var ordercontent=data.rows;
		var starttime=checkNull(ordercontent.starttime);
		var paytime=checkNull(ordercontent.paytime);
		var endtime=checkNull(ordercontent.endtime);
		var sum=0;   //商品全部加起来的价格
		var sname="";   //商品拼接起来的商品名
		
		$("#content_id2").empty();
		$("#content_buyer_addr2").val("");
		$("#content_maketime2").empty();
		$("#content_paytime2").empty();
		$("#content_suretime2").empty();
		$("#total_money2").empty();
		$("#content_buyer_name2").val("");
		$("#content_buyer_tel2").val("");
		$("#content_tbody2").empty();
		
		$("#content_id2").append(ordercontent.orderid);
		$("#content_buyer_addr2").val(ordercontent.readdr);
		$("#content_maketime2").append(starttime);
		$("#content_paytime2").append(paytime);
		$("#content_suretime2").append(endtime);
		//$("#total_money2").val(ordercontent.ordersum);
		console.info(starttime);
		$.post("addressServlet",{op:"findAddressByUsid",usid:ordercontent.usid},function(data){
			var ordercontent2=data.getidd;
			
			$("#content_buyer_name2").val(ordercontent2.addname);
			$("#content_buyer_tel2").val(ordercontent2.tel);
		},"json");
		//向方框中加值
		$.post("orderFormServlet",{op:"getOneOrderInfo",orderid:orderid},function(data){
      		for(var i=0;i<data.hhhgggg.length;i++){
      			$("#content_tbody2").append("<tr><th>"+data.hhhgggg[i]['proname']+"</th><th id='buchengda'><select name='tid' onchange='changePrice(this)' id='news_newstype' class='myinput'>"+data.hhhgggg[i]['nature']+"</th><th><input class='content_jiage' onblur='changemoney()' style='width:80px;'/></th><th><input class='content_jiage2' onblur='changemoney()' style='width:80px;'/>  </th><th class='lastwo'>"+data.hhhgggg[i]['status']+"<span class='thing_proid'>"+data.hhhgggg[i]['proid']+"</span></th></tr>");
      			
				console.info($("#content_tbody2").children("tr").eq(i).children("th").children("select").eq(1));
				$("#content_tbody2").children("tr").eq(i).children("th").eq(2).children("input").val(data.hhhgggg[i]['bqpri']);
				$("#content_tbody2").children("tr").eq(i).children("th").eq(3).children("input").val(data.hhhgggg[i]['pronum']);
				sum+=data.hhhgggg[i]['bqpri']*data.hhhgggg[i]['pronum'];
				sname+=data.hhhgggg[i]['proname']+",";
				//console.info($("#content_tbody2").children("tr").eq(i).children("th").eq(3).children("input"));
				//$(".content_jiage2").val(nn);
				tty = $("#content_tbody2").children("tr").length;
      		}
      		$("#total_money2").append(sum);
      		getNature(sname);
		},"json");
	},"json");
	
}

	var pid; 
	//弹开详情页面
	function showNewsDetail(orderid){
		$("#ordercontent_show_ordercontentInfo").dialog("open");
		$.post("orderContentServlet",{op:"findOrderContentByorderid",orderid:orderid},function(data){
			var ordercontent=data.rows;
			var starttime=checkNull(ordercontent.starttime);
			var paytime=checkNull(ordercontent.paytime);
			var endtime=checkNull(ordercontent.endtime);
			
			$("#content_id").empty();
			$("#content_buyer_addr").empty();
			$("#content_maketime").empty();
			$("#content_paytime").empty();
			$("#content_suretime").empty();
			$("#total_money").empty();
			$("#content_buyer_name").empty();
			$("#content_buyer_tel").empty();
			$("#content_tbody").empty();
			
			$("#content_id").append(ordercontent.orderid);
			$("#content_buyer_addr").append(ordercontent.readdr);
			$("#content_maketime").append(starttime);
			$("#content_paytime").append(paytime);
			$("#content_suretime").append(endtime);
			$("#total_money").append(ordercontent.ordersum);
	
			$.post("addressServlet",{op:"findAddressByUsid",usid:ordercontent.usid},function(data){
				var ordercontent2=data.getidd;
				$("#content_buyer_name").append(ordercontent2.addname);
				$("#content_buyer_tel").append(ordercontent2.tel);
			},"json");
			$.post("orderFormServlet",{op:"getOneOrderInfo",orderid:orderid},function(data){
          		for(var i=0;i<data.hhhgggg.length;i++){
					$("#content_tbody").append("<tr><th>"+data.hhhgggg[i]['proname']+"</th><th>"+data.hhhgggg[i]['nature']+"</th><th>"+data.hhhgggg[0]['bqpri']+"</th><th>"+data.hhhgggg[0]['pronum']+"</th><th class='llas'>"+data.hhhgggg[0]['status']+"</th></tr>");
          		}
			},"json");
		},"json");
	}
	function checkNull(data){
		if(data==null || data==""){
			return "待定";
		}else{
			return data.substr(0,10);
		}
	}
	//获取每一行的属性
	function getNature(data){
		$.post("productServlet",{op:"findNatureByName",name:data},function(data){
			/*var obj=$("#content_tbody2").children("tr").eq(i).children("th").eq(1).children("select");
			var opt;
			console.info(obj);
			$.each(data.natureo,function(index,item){
				opt="<option value='"+item.nature+"'>"+item.nature+"</option>";
				obj.append($(opt));
			});*/
			var nature = data.natureo;
			//根据列表的行数来循环
			for(var i=0;i<tty;i++){
				var ssname=$("#content_tbody2").children("tr").eq(i).children("th").eq(0).html();
				var ssid=$("#content_tbody2").children("tr").eq(i).children("th").eq(4).children("span").html()
				var obj = $("#content_tbody2").children("tr").eq(i).children("th").eq(1).children("select");
				var opt;
				//根据获取的属性数来循环
				for(var q=0;q<nature.length;q++){
					if(ssname==nature[q].proname){
						if(ssid==nature[q].proid){
							opt="<option value='"+nature[q].nature+"' selected='selected'>"+nature[q].nature+"</option>";
						}else{
							opt="<option value='"+nature[q].nature+"'>"+nature[q].nature+"</option>";
						}
						obj.append($(opt));
					}
				}
				
			}
		},"json");
	}
	//根据单价数量的改变，总金额也随之改变
	function changemoney(){
		$("#total_money2").empty();
		var summoney=0;
		for(var i=0;i<tty;i++){
			var thisdan=$("#content_tbody2").children("tr").eq(i).children("th").eq(2).children("input").val();
			var thisnum=$("#content_tbody2").children("tr").eq(i).children("th").eq(3).children("input").val();
			summoney+=thisdan*thisnum;
		}
		$("#total_money2").append(summoney);
	}
	//根据属性的不同改变价格
	function changePrice(data){
		var nnt = data.value;
		var nnn = $(data).parent().parent().children("th").eq(0).html();
		$.post("productServlet",{op:"findPriceByNameAndNature",nnn:nnn,nnt:nnt},function(data2){
			var datah = data2.ppri;
			$(data).parent().parent().children("th").eq(2).children("input").val("");
			$(data).parent().parent().children("th").eq(2).children("input").val(datah[0].bqpri);
			changemoney();
		},"json");
	}
	//提交修改的内容
	function sendInfo(){
		//买家姓名
		var buyername=$("#content_buyer_name2").val();
		//买家电话
		var buyertel=$("#content_buyer_tel2").val();
		//买家地址
		var buyeradd=$("#content_buyer_addr2").val();
		//订单编号
		var contentBigId = $("#content_id2").html();
		
		$.post("");
	}
</script>